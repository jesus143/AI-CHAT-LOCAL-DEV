<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>RAG AI Chat</title>
  <style>
    * { box-sizing: border-box; }
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; display: flex; height: 100vh; margin: 0; background: #f0f2f5; }
    
    /* Sidebar */
    #sidebar { width: 300px; background: white; border-right: 1px solid #e0e0e0; display: flex; flex-direction: column; padding: 20px; }
    #sidebar h2 { margin: 0 0 20px 0; font-size: 20px; color: #333; }
    
    /* Upload Area */
    #uploadArea { border: 2px dashed #0084ff; border-radius: 8px; padding: 30px; text-align: center; cursor: pointer; transition: all 0.3s; margin-bottom: 20px; }
    #uploadArea:hover { background: #f0f8ff; border-color: #0066cc; }
    #uploadArea.dragover { background: #e6f4ff; border-color: #0066cc; }
    #fileInput { display: none; }
    .upload-icon { font-size: 40px; color: #0084ff; margin-bottom: 10px; }
    .upload-text { color: #666; font-size: 14px; }
    
    /* Stats */
    #stats { background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
    #stats h3 { margin: 0 0 10px 0; font-size: 14px; color: #666; }
    .stat-item { display: flex; justify-content: space-between; margin: 5px 0; font-size: 13px; }
    .stat-label { color: #666; }
    .stat-value { font-weight: bold; color: #333; }
    
    /* File List */
    #fileList { background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px; max-height: 300px; overflow-y: auto; }
    #fileList h3 { margin: 0 0 10px 0; font-size: 14px; color: #666; }
    .file-item { display: flex; align-items: center; padding: 8px; margin: 4px 0; background: white; border-radius: 6px; font-size: 13px; }
    .file-item:hover { background: #f0f8ff; }
    .file-item input[type="checkbox"] { margin-right: 10px; cursor: pointer; }
    .file-name { flex: 1; color: #333; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .file-chunks { color: #666; font-size: 11px; margin-left: 5px; }
    .select-actions { display: flex; gap: 5px; margin-bottom: 10px; }
    .select-actions button { padding: 4px 8px; font-size: 11px; border: none; background: #0084ff; color: white; border-radius: 4px; cursor: pointer; }
    .select-actions button:hover { background: #0066cc; }
    
    /* Buttons */
    .btn { padding: 10px 15px; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; transition: all 0.2s; }
    .btn-danger { background: #dc3545; color: white; width: 100%; }
    .btn-danger:hover { background: #c82333; }
    
    /* Main Chat Area */
    #mainArea { flex: 1; display: flex; flex-direction: column; }
    #chat { flex: 1; padding: 20px; overflow-y: auto; background: #f5f5f5; display: flex; flex-direction: column; }
    .msg { margin: 5px 0; padding: 12px 16px; border-radius: 12px; max-width: 70%; white-space: pre-wrap; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
    .user { background: #0084ff; color: white; align-self: flex-end; }
    .ai { background: white; color: black; align-self: flex-start; }
    .typing { font-style: italic; color: gray; align-self: flex-start; padding: 8px 16px; }
    .rag-indicator { font-size: 11px; color: #28a745; margin-top: 5px; }
    pre { background: #2d2d2d; color: #f8f8f2; padding: 10px; border-radius: 6px; overflow-x: auto; margin: 10px 0; }
    code { font-family: 'Courier New', monospace; }
    
    /* Input Box */
    #inputBox { display: flex; border-top: 1px solid #e0e0e0; background: white; padding: 15px; gap: 10px; }
    #input { flex: 1; padding: 12px; border: 1px solid #e0e0e0; border-radius: 24px; outline: none; font-size: 14px; }
    #input:focus { border-color: #0084ff; }
    #send { padding: 12px 24px; border: none; background: #0084ff; color: white; cursor: pointer; border-radius: 24px; font-weight: 600; }
    #send:hover { background: #0066cc; }
    
    /* Toast notifications */
    .toast { position: fixed; top: 20px; right: 20px; background: #28a745; color: white; padding: 15px 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); z-index: 1000; animation: slideIn 0.3s; }
    .toast.error { background: #dc3545; }
    @keyframes slideIn { from { transform: translateX(400px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    
    /* Loading spinner */
    .spinner { border: 3px solid #f3f3f3; border-top: 3px solid #0084ff; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; display: inline-block; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  </style>
</head>
<body>
  <!-- Sidebar -->
  <div id="sidebar">
    <h2>üìö RAG Documents</h2>
    
    <!-- Upload Area -->
    <div id="uploadArea">
      <div class="upload-icon">üìÑ</div>
      <div class="upload-text">
        <strong>Click or drag files here</strong><br>
        <small>Supports PDF, DOCX, TXT</small>
      </div>
      <input type="file" id="fileInput" accept=".pdf,.docx,.txt" />
    </div>
    
    <!-- Stats -->
    <div id="stats">
      <h3>üìä Statistics</h3>
      <div class="stat-item">
        <span class="stat-label">Total Chunks:</span>
        <span class="stat-value" id="totalChunks">0</span>
      </div>
      <div class="stat-item">
        <span class="stat-label">Status:</span>
        <span class="stat-value" id="ragStatus">No documents</span>
      </div>
    </div>
    
    <!-- File List -->
    <div id="fileList" style="display: none;">
      <h3>üìÇ Uploaded Files</h3>
      <div class="select-actions">
        <button id="selectAll">Select All</button>
        <button id="deselectAll">Deselect All</button>
      </div>
      <div id="fileListContent"></div>
    </div>
    
    <!-- Clear Button -->
    <button class="btn btn-danger" id="clearBtn">üóëÔ∏è Clear All Documents</button>
  </div>
  
  <!-- Main Chat Area -->
  <div id="mainArea">
    <div id="chat"></div>
    <div id="inputBox">
      <input id="input" type="text" placeholder="Ask a question about your documents..." />
      <button id="send">Send</button>
    </div>
  </div>

  <script>
    const chat = document.getElementById("chat");
    const input = document.getElementById("input");
    const sendBtn = document.getElementById("send");
    const uploadArea = document.getElementById("uploadArea");
    const fileInput = document.getElementById("fileInput");
    const clearBtn = document.getElementById("clearBtn");
    const totalChunksEl = document.getElementById("totalChunks");
    const ragStatusEl = document.getElementById("ragStatus");
    const fileListEl = document.getElementById("fileList");
    const fileListContentEl = document.getElementById("fileListContent");
    const selectAllBtn = document.getElementById("selectAll");
    const deselectAllBtn = document.getElementById("deselectAll");

    const ws = new WebSocket("ws://localhost:3000");
    let typingDiv = null;
    let uploadedFiles = [];

    // WebSocket handlers
    ws.onmessage = (event) => {
      if (typingDiv) {
        typingDiv.remove();
        typingDiv = null;
      }
      const msg = JSON.parse(event.data);
      addMessage(msg.text, msg.sender, msg.usedRag);
    };

    ws.onopen = () => {
      console.log("WebSocket connected");
      updateStats();
    };

    // Chat functionality
    sendBtn.onclick = sendMessage;
    input.addEventListener("keypress", (e) => {
      if (e.key === "Enter") sendMessage();
    });

    function sendMessage() {
      const text = input.value.trim();
      if (text) {
        // Get selected files
        const selectedFiles = getSelectedFiles();
        
        // Send message with selected files info
        ws.send(JSON.stringify({
          message: text,
          selectedFiles: selectedFiles.length > 0 ? selectedFiles : null
        }));
        
        input.value = "";
        showTyping();
      }
    }
    
    function getSelectedFiles() {
      const checkboxes = document.querySelectorAll('.file-item input[type="checkbox"]:checked');
      return Array.from(checkboxes).map(cb => cb.value);
    }

    function addMessage(text, sender, usedRag = false) {
      const div = document.createElement("div");
      div.className = "msg " + sender;

      // detect if text contains code (```...```)
      if (text.includes("```")) {
        const parts = text.split(/```/);
        parts.forEach((part, i) => {
          if (i % 2 === 0) {
            if (part.trim()) {
              const span = document.createElement("div");
              span.textContent = part;
              div.appendChild(span);
            }
          } else {
            const pre = document.createElement("pre");
            const code = document.createElement("code");
            code.textContent = part.trim();
            pre.appendChild(code);
            div.appendChild(pre);
          }
        });
      } else {
        div.textContent = text;
      }

      // Add RAG indicator if context was used
      if (sender === "ai" && usedRag) {
        const indicator = document.createElement("div");
        indicator.className = "rag-indicator";
        indicator.textContent = "‚úì Answer based on your documents";
        div.appendChild(indicator);
      }

      chat.appendChild(div);
      chat.scrollTop = chat.scrollHeight;
    }

    function showTyping() {
      typingDiv = document.createElement("div");
      typingDiv.className = "msg typing";
      typingDiv.innerHTML = '<div class="spinner"></div> AI is thinking...';
      chat.appendChild(typingDiv);
      chat.scrollTop = chat.scrollHeight;
    }

    // File upload functionality
    uploadArea.onclick = () => fileInput.click();
    
    fileInput.onchange = (e) => {
      const file = e.target.files[0];
      if (file) uploadFile(file);
    };

    // Drag and drop
    uploadArea.ondragover = (e) => {
      e.preventDefault();
      uploadArea.classList.add("dragover");
    };

    uploadArea.ondragleave = () => {
      uploadArea.classList.remove("dragover");
    };

    uploadArea.ondrop = (e) => {
      e.preventDefault();
      uploadArea.classList.remove("dragover");
      const file = e.dataTransfer.files[0];
      if (file) uploadFile(file);
    };

    async function uploadFile(file) {
      const formData = new FormData();
      formData.append("file", file);

      showToast(`Uploading ${file.name}...`);

      try {
        const response = await fetch("http://localhost:5001/upload", {
          method: "POST",
          body: formData
        });

        const data = await response.json();

        if (response.ok) {
          showToast(`‚úì ${file.name} uploaded successfully! Created ${data.num_chunks} chunks.`, "success");
          updateStats();
          fileInput.value = ""; // Reset input
        } else {
          showToast(`Error: ${data.error}`, "error");
        }
      } catch (error) {
        showToast(`Upload failed: ${error.message}`, "error");
      }
    }

    // Stats update
    async function updateStats() {
      try {
        const response = await fetch("http://localhost:5001/stats");
        const data = await response.json();
        
        totalChunksEl.textContent = data.total_chunks || 0;
        ragStatusEl.textContent = data.total_chunks > 0 ? "Ready" : "No documents";
        ragStatusEl.style.color = data.total_chunks > 0 ? "#28a745" : "#666";
        
        // Also update file list
        await updateFileList();
      } catch (error) {
        console.error("Error fetching stats:", error);
      }
    }
    
    // File list update
    async function updateFileList() {
      try {
        const response = await fetch("http://localhost:5001/files");
        const data = await response.json();
        uploadedFiles = data.files || [];
        
        if (uploadedFiles.length > 0) {
          fileListEl.style.display = "block";
          renderFileList();
        } else {
          fileListEl.style.display = "none";
        }
      } catch (error) {
        console.error("Error fetching files:", error);
      }
    }
    
    function renderFileList() {
      fileListContentEl.innerHTML = "";
      
      uploadedFiles.forEach(file => {
        const fileItem = document.createElement("div");
        fileItem.className = "file-item";
        
        const checkbox = document.createElement("input");
        checkbox.type = "checkbox";
        checkbox.value = file.filename;
        checkbox.checked = true; // Default: all files selected
        
        const fileName = document.createElement("span");
        fileName.className = "file-name";
        fileName.textContent = file.filename;
        fileName.title = file.filename; // Full name on hover
        
        const fileChunks = document.createElement("span");
        fileChunks.className = "file-chunks";
        fileChunks.textContent = `(${file.chunk_count} chunks)`;
        
        fileItem.appendChild(checkbox);
        fileItem.appendChild(fileName);
        fileItem.appendChild(fileChunks);
        
        fileListContentEl.appendChild(fileItem);
      });
    }
    
    // Select/Deselect all
    selectAllBtn.onclick = () => {
      document.querySelectorAll('.file-item input[type="checkbox"]').forEach(cb => cb.checked = true);
    };
    
    deselectAllBtn.onclick = () => {
      document.querySelectorAll('.file-item input[type="checkbox"]').forEach(cb => cb.checked = false);
    };

    // Clear documents
    clearBtn.onclick = async () => {
      if (!confirm("Are you sure you want to clear all documents?")) return;

      try {
        const response = await fetch("http://localhost:5001/clear", {
          method: "POST"
        });

        const data = await response.json();

        if (response.ok) {
          showToast("All documents cleared!", "success");
          updateStats();
        } else {
          showToast(`Error: ${data.error}`, "error");
        }
      } catch (error) {
        showToast(`Clear failed: ${error.message}`, "error");
      }
    };

    // Toast notifications
    function showToast(message, type = "success") {
      const toast = document.createElement("div");
      toast.className = `toast ${type}`;
      toast.textContent = message;
      document.body.appendChild(toast);

      setTimeout(() => {
        toast.remove();
      }, 3000);
    }

    // Initialize stats on load
    updateStats();
  </script>
</body>
</html>
